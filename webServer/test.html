<!DOCTYPE html>
<html>
<head>
   <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
</head>
<body>

<canvas id="myCanvas" width="400" height="400" style="border:1px solid #000000;">
Your browser does not support the HTML canvas tag.
</canvas>
<br/>
<button type="submit" id="restartBtn"  onclick= "sendRestart()">restart</button>
<button type="submit" id="exitBtn"     onclick= "sendExit()">exit</button>
<button type="submit" id="clearPtsBtn" onclick= "clearPoints()">clearPoints</button>
<button type="submit" id="sendPtsBtn"  onclick= "sendPoints()" >sendPoints</button>
<input  type="color"  id="laserColour" name="head" value="#e66465">

<script>

let pointListX = new Array();
let pointListY = new Array();

var numPoints = 0;

var c = document.getElementById("myCanvas");
var ctx = c.getContext("2d");
var cvWidth  = c.width;
var cvHeight = c.height;

function map(x, in_min, in_max, out_min, out_max) 
{
      return (x - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
}

function hexToRgb(hex) 
{
  var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result ? {
    r: parseInt(result[1], 16),
    g: parseInt(result[2], 16),
    b: parseInt(result[3], 16)
  } : null;
}

function sendPoints()
{
	console.log("sendPoints");
//	$.getJSON('sensor.php', function(data) {
//  		alert('Room temperature: '+data.temp1+', outside temperature: '+data.temp2)
//	});
	var pointList = [];
	pointList.push("addShape");

	// Add the colour
        var rgbLaserCol = hexToRgb( document.getElementById("laserColour").value );
        console.log("laserCol: " + rgbLaserCol.r + "," + rgbLaserCol.g + "," + rgbLaserCol.b);
	
	pointList.push( rgbLaserCol.r );
	pointList.push( rgbLaserCol.g );
	pointList.push( rgbLaserCol.b );

  	for(let i = 0; i < numPoints;i++)
  	{
		var mX = map( pointListX[i], 0, cvWidth,  -100, 100 );
		var mY = map( pointListY[i], 0, cvHeight, -100, 100 );
		console.log("adding: " + mX + "," + mY);
        	pointList.push( mX );
        	pointList.push( mY );
  	}
	console.log("pointList.length: " + pointList.length);

	var rgbLaserCol = hexToRgb( document.getElementById("laserColour").value );	
  	
	console.log("laserCol: " + rgbLaserCol.r + "," + rgbLaserCol.g + "," + rgbLaserCol.b);
	$.ajax({
       		type: "POST",
       		url:  'sendPoints.php',
       		data: "pointList="+ pointList,
       			success: function() 
			{
            			$("#lengthQuestion").fadeOut('slow');
       			}
  		});	
}

function sendExit()
{
	$.ajax({
                type: "POST",
                url:  'sendExit.php',
                });
}

function sendRestart()
{
        $.ajax({
                type: "POST",
                url:  'sendRestart.php',
                }); 
}

function clearPoints() {
  var x = document.getElementById("sendPtsBtn");

  numPoints = 0;
  pointListX = new Array();
  pointListY = new Array();
}
var fps = 30;


function draw() 
{
    setTimeout(function() 
    {
        requestAnimationFrame(draw);

  	// call again next time we can draw
  	ctx.clearRect(0, 0, cvWidth, cvHeight);

  	ctx.strokeStyle = document.getElementById("laserColour").value;
  	ctx.stroke();
	ctx.beginPath();
  	for (let i = 0; i < numPoints; i++) {
		if(i == 0)
			ctx.moveTo( pointListX[i], pointListY[i]);
		else
			ctx.lineTo(pointListX[i], pointListY[i]);
		//ctx.rect( pointListX[i], pointListY[i], 5, 5);
  	}
    }, 1000 / fps);
}
draw();

// click handler to add random rects
window.addEventListener('click', function(event) 
{
  
   if( event.clientX < cvWidth && event.clientY < cvHeight )
   {	 
	pointListX.push( event.clientX );
	pointListY.push( event.clientY );
	numPoints++;
   }	
});

</script>

</body>
</html>

